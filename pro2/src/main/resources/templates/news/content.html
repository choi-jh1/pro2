<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${news.title}">뉴스 상세</title>
</head>

<body>
	
	<!-- 기사 제목 -->
	<h1 th:text="${news.title}">기사 제목</h1>
	
	<!-- 작성일 -->
	<p>
		작성일 : <span th:text="${#temporals.format(news.reg, 'yyyy-MM-dd HH:mm')}"></span><br>
	</p>
	
	<!-- 기자 정보 -->
	<div>
		<img th:src="${news.profile_img}" alt="기자 사진" width="60" height="60">
		<p th:text="${news.writerName}">기자 이름 나옴</p>
	</div>
	
	<!-- 기사 본문 -->
	<div>
		<p th:utext="${news.content}">기사 본문 나옴</p>
	</div>
	
	<!-- 추천 -->
	<div>
		<form th:action="@{/news/hot}" method="post">
			<input type="hidden" name="num" th:value="${news.num}">
			<button type="submit">추천</button>
			<span>추천 수 : <span th:text="${news.hot}">0</span></span>
		</form>
	</div>
	
	<!-- 댓글 작성 -->
	<div>
		<h3>댓글</h3>
		<form th:action="@{/comment/add}" method="post">
			<input type="hidden" name="num" th:value="${news.num}">
			<textarea name="content" rows="4" cols="60" placeholder="댓글을 입력하세요."></textarea><br>
			<button type="submit">댓글 등록</button>
		</form>
	</div>
	
	<!-- 댓글 목록 -->
	<p th:text="${#lists.size(commentList)}">댓글 수</p>
	<ul id="commentUl">
	  <li th:each="comment : ${commentList}">
		<div th:style="'margin-left: ' + (${comment.re_level} * 10) + 'px;'">
	      <strong th:text="${comment.writer}">작성자</strong> :
	      <span th:text="${comment.content}">댓글 내용</span><br>
	      <span th:text="${#temporals.format(comment.reg, 'yyyy-MM-dd HH:mm')}">작성 시간</span>
	    
		  <form th:action="@{/comment/delete}" method="post" style="display:inline;">
		  	<input type="hidden" name="com_num" th:value="${comment.com_num}" />
		    <input type="hidden" name="num" th:value="${news.num}" />
		    <button type="submit" onclick="return confirm('댓글을 삭제하시겠습니까?');">삭제</button>
		  </form>
	  </div>
	  </li>
	</ul>

	<!-- 스크립트 영역 -->
	<script>
		// 무한 스크롤 Ajax 댓글 추가 로딩
		let page = 1;  // 현재 댓글 페이지 (서버에서 이미 1페이지 렌더링 완료 상태)
		let isLoading = false; // 요청 중복 방지
		let hasMore = true;    // 더 불러올 댓글 여부

		window.addEventListener('scroll', () => {
			// 페이지 맨 아래 100px 근처 도달 시
			if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
				if (!isLoading && hasMore) {
					loadMoreComments();
				}
			}
		});

		function loadMoreComments() {
			isLoading = true;
			page++;  // 다음 페이지 요청

			// Thymeleaf 변수 치환
			const newsNum = /*[[${news.num}]]*/ 0;

			fetch(`/comment/load?num=${newsNum}&page=${page}`)
				.then(response => response.json())
				.then(data => {
					if (data.length === 0) {
						hasMore = false;
						return;
					}

					const commentUl = document.getElementById("commentUl");

					data.forEach(comment => {
						const li = document.createElement("li");

						const marginLeft = comment.re_level * 10;
						const regTime = new Date(comment.reg).toLocaleString();

						li.innerHTML = `
							<div style="margin-left: ${marginLeft}px;">
								<div>
									<strong>${comment.writer}</strong> :
									<span>${comment.content}</span><br>
									<span>${regTime}</span>
								</div>
							</div>
						`;

						commentUl.appendChild(li);
					});
				})
				.catch(error => {
					console.error('댓글 불러오기 실패:', error);
				})
				.finally(() => {
					isLoading = false;
				});
		}
	</script>
</body>
</html>
