<link rel="stylesheet" th:href="@{/css/listModal.css}">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<center><div class="logo"><a href="/user/main"><img src="/images/logo.png"></a></div></center>

<!-- ì œë³´ ì—†ìŒ -->
<div th:if="${reportCount==0}">
  <table width="500" cellspacing="0" cellpadding="0" border="1" align="center">
    <tr align="center">
      <a th:href="@{/report/write}">ì œë³´í•˜ê¸°</a>
      <td><h3>ì œë³´ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</h3></td>
    </tr>
  </table>
</div>

<!-- ì œë³´ ìˆìŒ -->
<div th:unless="${reportCount==0}">
<div th:if="${session.role != 'admin' and session.role != 'reporter'}">
  <center><a th:href="@{/report/write}">ì œë³´í•˜ê¸°</a></center>
</div>
  <table width="500" cellspacing="0" cellpadding="0" border="1" align="center">
    <tr height="30">
      <th>ì œë³´ ê¸€ ë²ˆí˜¸</th>
      <th>ì œë³´ ê¸€ ì œëª©</th>
      <th>ì‘ì„±ì¼</th>
    </tr>
    <tr align="center"  th:each="report : ${list}">
      <td th:text="${report.report_id}"></td>
      <td>
        <!-- ì ‘ê·¼ ê°€ëŠ¥í•œ ì‚¬ìš©ì -->
        <span th:if="${session.sid == report.writer_id or session.role == 'admin' or session.sid == report.assigned}">
          <a th:href="@{|/report/content?pageNum=${pageNum}&report_id=${report.report_id}|}">
            <span th:text="${report.title}"></span>
          </a>
        </span>

        <!-- ë¹„ë°€ê¸€ ì²˜ë¦¬ -->
        <span th:unless="${session.sid == report.writer_id or session.role == 'admin' or session.sid == report.assigned}">
          <a href="#" 
             class="pw-check-link" 
             th:data-report-id="${report.report_id}" 
             th:data-page-num="${pageNum}">
             ğŸ”’ ë¹„ë°€ê¸€ì…ë‹ˆë‹¤.
          </a>
        </span>
      </td>
      <td th:text="${#temporals.format(report.reg, 'yy-MM-dd HH:mm')}"></td>
    </tr>
  </table>
</div>

<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
<div align="center" th:if="${reportCount > 0}">
  <span th:if="${startPage > 10}">
    <a th:href="@{|/report/list?pageNum=${startPage - 10}|}">[ì´ì „]</a>
  </span>
  <span th:if="${endPage < pageCount}">
    <a th:href="@{|/report/list?pageNum=${startPage + 10}|}">[ë‹¤ìŒ]</a>
  </span>
  <span th:each="i : ${#numbers.sequence(startPage, endPage)}">
    <a th:href="@{|/report/list?pageNum=${i}|}" th:text="'[' + ${i} + ']'"></a>
  </span>
</div>

<!-- âœ… ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ -->
<div id="pwModal" class="modal-background" style="display: none;">
  <div class="modal-content">
    <p>ğŸ”’ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
    <input type="password" id="inputPw" class="modal-input" />
    <input type="hidden" id="hiddenReportId" />
    <input type="hidden" id="hiddenPageNum" />
    <div class="modal-buttons">
      <button id="pwSubmitBtn" class="modal-btn">í™•ì¸</button>
      <button class="close-modal modal-btn">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- âœ… ëª¨ë‹¬ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
$(document).ready(function () {
  // ë¹„ë°€ê¸€ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
  $(".pw-check-link").click(function (e) {
    e.preventDefault();
    const reportID = $(this).data("report-id");
    const pageNum = $(this).data("page-num");
    $("#hiddenReportId").val(reportID);
    $("#hiddenPageNum").val(pageNum);
    $("#inputPw").val("");
    $("#pwModal").show();
  });

  // ëª¨ë‹¬ ë‹«ê¸°
  $(".close-modal").click(function () {
    $("#pwModal").hide();
  });

  // í™•ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ AJAX ìš”ì²­
  $("#pwSubmitBtn").click(function () {
    const reportId = $("#hiddenReportId").val();
    const password = $("#inputPw").val();
    const pageNum = $("#hiddenPageNum").val();

    $.ajax({
      url: "/report/checkPw",
      type: "POST",
      data: { report_id: reportId, password: password },
      success: function (result) {
        if (result === "success") {
          location.href = "/report/content?pageNum=" + pageNum + "&report_id=" + reportId;
        }
      },
      error: function (xhr) {
        if (xhr.status === 401) {
          alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤");
        } else {
          alert("âš ï¸ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
        }
      }
    });
  });
});
</script>
